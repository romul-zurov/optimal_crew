unit crew_utils;

interface

function replace_minute(const value : string; const MyTime : TDateTime) : string;

implementation

uses StrUtils, DateUtils;


function replace_minute(const value : string; const MyTime : TDateTime) : string;
var
	p1, p2, n : integer;
	res, s, s2 : string;

begin
	res := value;
	repeat
		p1 := pos('{Last_minute_', res);
		p2 := posex('}', res, p1);
		if (p1 > 0) and (p2 > 0) then
		begin
			p1 := p1 + 13;
			s := copy(res, p1, p2 - p1);
			if s <> '' then
			begin
				try
					n := strtoint(s);
					if (n > 0) and (n <= 59) then
					begin
						DateTimeToString(s2, 'yyyy-mm-dd hh:nn:ss', IncMinute(MyTime, n * (-1)));
						res := ReplaceStr(res, '{Last_minute_' + s + '}', s2);
					end;
				except
					n := 0;
				end;
			end;
		end;
	until (p1 = 0) or (p2 = 0) or (n <= 0);

	result := res;
end;

end.
